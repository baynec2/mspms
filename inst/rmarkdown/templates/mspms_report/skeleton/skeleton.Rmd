---
title: "MSPMS Report"
date: "`r Sys.Date()`"
output:
  html_document:
        theme: cosmo
        toc: true
        toc_depth: 6
        toc_float:
            collapsed: true
            smooth_scroll: true
        code_folding: hide
        highlight: tango
        df_print: paged
params:
  prepared_data: NULL
  design_matrix: NULL
  peptide_library: mspms::peptide_library
  n_residues: 4
---

```{r setup, include=FALSE}
library(dplyr)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

# Info

This report has been automatically generated by the mspms package. It contains standard results of the mspms analysis pipeline. 


R session info is as follows:  

```{r}
sessionInfo()
```
# Data Processing 

```{r}
# The standard mspms data processing pipeline is used here. 
mspms_data = mspms::mspms(prepared_data,design_matrix)

mspms_data %>%
  downloadthis::download_this(
    output_name = "mspms_data",
    output_extension = ".csv",
    button_label = "Download data",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save",
    csv2 = FALSE
  )
```

# QC Checks 

```{r}
qc_checks = mspms::qc_check(prepared_data,peptide_library,design_matrix)

DT::datatable(qc_checks)

qc_checks %>%
  downloadthis::download_this(
    output_name = "qc_checks",
    output_extension = ".csv",
    button_label = "Download qc_check",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save",
    csv2 = FALSE
  )
```

**Table 1.** Here the percentage of the peptide library that is detected in 
each sample is displayed.


```{r}
mspms::plot_qc_check(qc_checks)

```

**Figure 1.** Here the results of the qc checks are displayed. 


```{r}
nd_peptides = mspms::find_nd_peptides(prepared_data,
                                      peptide_library,
                                      design_matrix)

DT::datatable(nd_peptides)

nd_peptides %>%
  downloadthis::download_this(
    output_name = "nd_peptides",
    output_extension = ".csv",
    button_label = "Download nd_peptides",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save",
    csv2 = FALSE
  )
```

**Table 2.** Here the peptides missing from each sample are shown


```{r}
plot_nd_peptides(nd_peptides)
```

**Figure 2.** Here the library peptides not detected in each samples are shown. 

```{r}
plot_rt_qc(prepared_data,design_matrix)
```


**Figure 3.** Here the distribution of peptides detected per retention time are 
shown for each group.

# Overview 
```{r}
mspms::plot_pca(mspms_data)
```

**Figure 4.** Here a PCA of the experiment is displayed. The color represents time, while shape and linetype of eclipse (if there are enough points to calculate) represents condition. 


```{r,fig.height = 8, fig.width = 10}
mspms::plot_heatmap(mspms_data)
```

**Figure 5.** Here an interactive heatmap of the experiment is displayed. Mouse over to see more information on each cell. Column side colors represent condition and time. 

# Statistics 

```{r}
t1 = mspms::mspms_anova(mspms_data) %>% 
  dplyr::arrange(p.adj)

DT::datatable(t1)

t1 %>%
  downloadthis::download_this(
    output_name = "mspms_anova",
    output_extension = ".csv",
    button_label = "Download anova",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save",
    csv2 = FALSE
  )
```

**Table 3. ** Here anova results are displayed for each condition (testing to see if there is an effect on time). 


```{r}
t2 = mspms::log2fc_t_test(mspms_data) %>% 
  dplyr::arrange(p.adj)

DT::datatable(t2)

t2 %>%
  downloadthis::download_this(
    output_name = "mspms_t-tests",
    output_extension = ".csv",
    button_label = "Download ttests",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save",
    csv2 = FALSE
  )
```

**Table 4.** Here T-test results are displayed as compared to time 0 for each condition


```{r}
mspms::plot_volcano(t2)
```

**Figure 5.** Here the Log2fc and T tests are displayed as volcano plots relative to T0 for each condition. 

# Cleavage Motifs

```{r,fig.height = 10, fig.width = 6}

tryCatch({
  print(mspms::plot_all_icelogos(mspms_data))
}, error = function(e) {
  print(e)
})
```



**Figure 6.** Here the cleavage motifs enriched in each condition are shown. 
Enriched cleavage motifs are defined as having a p.adj <= 0.05 and a log2fc >3
relative to time 0. 


# Position Specificity 

```{r}
sig = t2 %>% 
  dplyr::filter(p.adj <= 0.05, log2fc >3)

d = mspms::count_cleavages_per_pos(sig)

tryCatch({
  print(mspms::plot_cleavages_per_pos(d))
}, error = function(e) {
  print(e)
})
```

**Figure 7.** Here the count of significant cleavages at each position of the 
peptide library are shown for each condition (facet) per time point (color). 
Significant cleavages are defined as having a p.adj <= 0.05 and a log2fc > 3 
relative to time 0.  




